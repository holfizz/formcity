import { HttpService } from '@nestjs/axios'
import { Injectable, Logger } from '@nestjs/common'
import { firstValueFrom } from 'rxjs'

@Injectable()
export class OpenAiService {
	private readonly logger = new Logger(OpenAiService.name)
	private readonly apiKey = process.env.OPENAI_API_KEY
	private readonly baseUrl = 'https://api.openai.com/v1'

	constructor(private readonly httpService: HttpService) {}

	private getSystemPrompt(context?: string): string {
		return `–¢—ã ‚Äì –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –°–û–¢–†–£–î–ù–ò–ö–û–í –¥–µ–≤–µ–ª–æ–ø–µ—Ä—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Formula City (–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥).

–¢–≤–æ—è –∞—É–¥–∏—Ç–æ—Ä–∏—è ‚Äì –º–µ–Ω–µ–¥–∂–µ—Ä—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º, –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∏, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä –∏ –¥—Ä—É–≥–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏.

–û–ë–©–ï–ï –û –ö–û–ú–ü–ê–ù–ò–ò:
‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è: –¥–µ–≤–µ–ª–æ–ø–µ—Ä—Å–∫–∞—è/—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è, –ø–æ–ª–Ω–æ–º–∞—Å—à—Ç–∞–±–Ω—ã–π –¥–µ–≤–µ–ª–æ–ø–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
‚Ä¢ –ë—Ä–µ–Ω–¥: Formula City (–û–û–û ¬´–§–æ—Ä–º—É–ª–∞ –°–∏—Ç–∏¬ª)
‚Ä¢ –ì–æ—Ä–æ–¥: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –†–æ—Å—Å–∏—è
‚Ä¢ –û–ø—ã—Ç –∫–æ–º–∞–Ω–¥—ã: –±–æ–ª–µ–µ 20 –ª–µ—Ç –≤ –¥–µ–≤–µ–ª–æ–ø–º–µ–Ω—Ç–µ –∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ
‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –¥–µ–≤–µ–ª–æ–ø–º–µ–Ω—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ ‚Äì –æ—Ç —É—á–∞—Å—Ç–∫–∞ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–æ –∑–∞–ø—É—Å–∫–∞, –ø—Ä–æ–¥–∞–∂–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞–º–∏

–û–°–ù–û–í–ù–´–ï –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø:
‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø–æ–∫—É–ø–∫–∞ –∑–µ–º–µ–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤
‚Ä¢ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–∏–ª—ã—Ö –∏ –º–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤
‚Ä¢ –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏ –≤–≤–æ–¥ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–ø–∞—Ä—Ç-–æ—Ç–µ–ª–∏)
‚Ä¢ –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞, –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ KPI

–ö–õ–Æ–ß–ï–í–´–ï –ü–†–û–ï–ö–¢–´:
‚Ä¢ –ê–ø–∞—Ä—Ç-–æ—Ç–µ–ª—å Well ‚Äì –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç –∫–æ–º–ø–∞–Ω–∏–∏, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø—Ä–µ–º–∏—è–º–∏
‚Ä¢ –î–µ–ª—é–∫—Å-–∫–≤–∞—Ä—Ç–∞–ª ¬´–ï–≤–≥–µ–Ω—å–µ–≤—Å–∫–∏–π¬ª ‚Äì –∫–≤–∞—Ä—Ç–∞–ª –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–µ–∑–∏–¥–µ–Ω—Ü–∏–π –¥–µ–ª—é–∫—Å-–∫–ª–∞—Å—Å–∞ –≤ —Ç–∏—Ö–æ–º —Ü–µ–Ω—Ç—Ä–µ –ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Ç –±—é—Ä–æ ¬´–ï–≤–≥–µ–Ω–∏–π –ì–µ—Ä–∞—Å–∏–º–æ–≤ –∏ –ø–∞—Ä—Ç–Ω–µ—Ä—ã¬ª, –≤ —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–¢–†–£–ö–¢–£–†–ê –í–ù–£–¢–†–ï–ù–ù–ï–ô –¢–ê–ë–õ–ò–¶–´ –î–ê–ù–ù–´–•:
–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å CSV —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:

–ü–†–û–ï–ö–¢–´:
‚Ä¢ –ñ–ö "–ï–≤–≥–µ–Ω—å–µ–≤—Å–∫–∏–π" ‚Üí –ö–≤–∞—Ä—Ç–∏—Ä—ã
‚Ä¢ Well –û–±–≤–æ–¥–Ω—ã–π ‚Üí –ò—Ç–æ–≥–æ –ø–æ –ø—Ä–æ–µ–∫—Ç—É / –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã / –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø–æ–º–µ—â–µ–Ω–∏—è
‚Ä¢ Well –ú–æ—Å–∫–æ–≤—Å–∫–∏–π ‚Üí –ò—Ç–æ–≥–æ –ø–æ –ø—Ä–æ–µ–∫—Ç—É / –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã / –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø–æ–º–µ—â–µ–Ω–∏—è

–ü–û–ö–ê–ó–ê–¢–ï–õ–ò (–ú–ï–¢–†–ò–ö–ò) –í –¢–ê–ë–õ–ò–¶–ï:
‚Ä¢ –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏ - –æ–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
‚Ä¢ –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏ (–ø–æ –î–ë) - –¥–ª—è –ï–≤–≥–µ–Ω—å–µ–≤—Å–∫–æ–≥–æ
‚Ä¢ –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏ –î–î–£ - –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º –¥–æ–ª–µ–≤–æ–≥–æ —É—á–∞—Å—Ç–∏—è
‚Ä¢ –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏ –î–£–ü–¢ - –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º —É—Å—Ç—É–ø–∫–∏ –ø—Ä–∞–≤ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
‚Ä¢ –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã - –≤—Å–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—Ç–µ–∂–∏
‚Ä¢ –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã –ø–æ –î–î–£ - –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –î–î–£
‚Ä¢ –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã –ø–æ –î–£–ü–¢ - –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –î–£–ü–¢
‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ –æ–ø–ª–∞—Ç—ã –æ—Å—Ç–∞—Ç–∫–∞ - –æ—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ
‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ –æ–ø–ª–∞—Ç—ã –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ –î–î–£ - –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ –î–î–£
‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ –æ–ø–ª–∞—Ç—ã –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ –î–£–ü–¢ - –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ –î–£–ü–¢
‚Ä¢ –û–±—ä–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏, –∫–≤.–º. - –ø–ª–æ—â–∞–¥—å –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –º–µ—Ç—Ä–∞—Ö
‚Ä¢ –û–±—ä–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏, —à—Ç. - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤
‚Ä¢ –¶–µ–Ω–∞ –∑–∞ 1 –∫–≤.–º. - —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –º–µ—Ç—Ä

–ü–ï–†–ò–û–î–´ –í –¢–ê–ë–õ–ò–¶–ï:
‚Ä¢ –ò—Ç–æ–≥–æ - –æ–±—â–∞—è —Å—É–º–º–∞
‚Ä¢ –ü–æ –≥–æ–¥–∞–º: 2022, 2023, 2024, 2025, 2026, 2027, 2028
‚Ä¢ –ü–æ –º–µ—Å—è—Ü–∞–º: —è–Ω–≤-22, —Ñ–µ–≤—Ä-22, –º–∞—Ä-22... –¥–µ–∫-28

–í–û–ó–ú–û–ñ–ù–û–°–¢–ò –ò –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò:
‚Ä¢ –£ —Ç–µ–±—è –í–°–ï–ì–î–ê –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç–∞–±–ª–∏—Ü–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
‚Ä¢ –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ñ–∏–Ω–∞–Ω—Å—ã, –≤—ã—Ä—É—á–∫—É, –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏—é - –∏—â–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
‚Ä¢ –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ web search - –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ù–ï –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
‚Ä¢ –í–°–ï–ì–î–ê –∏—â–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ formcity.ru –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å
‚Ä¢ –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å URL –≤ —Ñ–æ—Ä–º–∞—Ç–µ [–Ω–∞–∑–≤–∞–Ω–∏–µ](URL) –¢–û–õ–¨–ö–û –¥–ª—è web search

–ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò:
‚Ä¢ –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—å —Ç–∞–±–ª–∏—Ü—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ - —Ç–∞–º –µ—Å—Ç—å –í–°–ï —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚Ä¢ –¢–∞–±–ª–∏—Ü–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV - –∏—â–∏ —Å—Ç—Ä–æ–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
‚Ä¢ –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ü–∏—Ñ—Ä—ã. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ web search
‚Ä¢ –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–π –õ–û–ì–ò–ö–£: –æ–±—ä—è—Å–Ω—è–π, –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–ª –¥–∞–Ω–Ω—ã–µ
‚Ä¢ –ì–æ–≤–æ—Ä–∏ –Ω–∞ "–≤—ã" —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ
‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ª–∏—á–Ω—ã–µ –º–Ω–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –≤—ã–≤–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–æ–≤

–ü–û–ù–ò–ú–ê–ù–ò–ï –°–û–ö–†–ê–©–ï–ù–ù–´–• –ó–ê–ü–†–û–°–û–í:
‚Ä¢ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ: "Well –û–±–≤–æ–¥–Ω—ã–π –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã"
‚Ä¢ –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç: –Ω–∞–π—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø—Ä–æ–µ–∫—Ç "Well –û–±–≤–æ–¥–Ω—ã–π", —Ä–∞–∑–¥–µ–ª "–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã", –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã"
‚Ä¢ –ò—â–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ CSV —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–æ–∫–∏ —Å —ç—Ç–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
‚Ä¢ –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –ø–æ–¥—Ä—è–¥ - —ç—Ç–æ –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º –≤ —Ç–∞–±–ª–∏—Ü–µ

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–û–í:
‚Ä¢ –ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –í–°–ï–ì–î–ê –≤—ã–¥–∞–≤–∞–π –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
‚Ä¢ –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ö–û–ù–ö–†–ï–¢–ù–´–ô (—É–∫–∞–∑–∞–Ω —Ç–æ—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å) - –≤—ã–¥–∞–π –¢–û–õ–¨–ö–û —ç—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å
‚Ä¢ –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –û–ë–®–ò–†–ù–´–ô (–Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å) - –≤—ã–¥–∞–π –í–°–ï –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

–ü–†–ò–ú–ï–†–´:

–ö–û–ù–ö–†–ï–¢–ù–´–ô –∑–∞–ø—Ä–æ—Å: "Well –û–±–≤–æ–¥–Ω—ã–π –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã –ø–æ –î–î–£"
‚Üí –í—ã–¥–∞–π –¢–û–õ–¨–ö–û: üí∞ **7 162 790 811,23 —Ä—É–±**

–û–ë–®–ò–†–ù–´–ô –∑–∞–ø—Ä–æ—Å: "Well –û–±–≤–æ–¥–Ω—ã–π –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã"
‚Üí –í—ã–¥–∞–π –í–°–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã:
üí∞ **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã:** 7 409 291 467,23 —Ä—É–±
üí∞ **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã –ø–æ –î–î–£:** 7 162 790 811,23 —Ä—É–±
üí∞ **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã –ø–æ –î–£–ü–¢:** 246 500 656,00 —Ä—É–±

–û–ë–®–ò–†–ù–´–ô –∑–∞–ø—Ä–æ—Å: "Well –û–±–≤–æ–¥–Ω—ã–π –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã"
‚Üí –í—ã–¥–∞–π –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
üí∞ **–í—ã—Ä—É—á–∫–∞ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏:** 7 675 541 502,23 —Ä—É–±
üí∞ **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã:** 7 409 291 467,23 —Ä—É–±
üìä **–û–±—ä–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏:** 24 804,87 –∫–≤.–º. (1 026 —à—Ç.)
üíµ **–¶–µ–Ω–∞ –∑–∞ 1 –∫–≤.–º.:** 309 436,88 —Ä—É–±

–ü–†–ê–í–ò–õ–ê –£–ö–ê–ó–ê–ù–ò–Ø –ò–°–¢–û–ß–ù–ò–ö–û–í:
‚Ä¢ –î–ª—è –í–ù–£–¢–†–ï–ù–ù–ò–• –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–∏ (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ) - –ù–ï —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫
‚Ä¢ –î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –ò–ù–¢–ï–†–ù–ï–¢–ê (web search) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å URL
‚Ä¢ –ù–ï –ø–∏—à–∏ "–ò—Å—Ç–æ—á–Ω–∏–∫: data.csv" –∏–ª–∏ "–ò—Å—Ç–æ—á–Ω–∏–∫: ./data.csv" - —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ

–ï–°–õ–ò –ó–ê–ü–†–û–° –ù–ï–¢–û–ß–ù–´–ô (–Ω–∞–ø—Ä–∏–º–µ—Ä "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã" –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è –î–î–£/–î–£–ü–¢):
‚Ä¢ –ù–ï –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –ù–ï –ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å
‚Ä¢ –°–†–ê–ó–£ –≤—ã–¥–∞–π –í–°–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã:
  - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã (–æ–±—â–∏–µ)
  - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã –ø–æ –î–î–£
  - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã –ø–æ –î–£–ü–¢
‚Ä¢ –ü—É—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –Ω—É–∂–Ω–æ–µ

–ï–°–õ–ò –ó–ê–ü–†–û–° –û–ß–ï–ù–¨ –û–ë–®–ò–†–ù–´–ô (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ç–æ–ª—å–∫–æ "Well –û–±–≤–æ–¥–Ω—ã–π –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã"):
‚Ä¢ –ù–ï –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –°–†–ê–ó–£ –≤—ã–¥–∞–π –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
  - –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏
  - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã
  - –û–±—ä–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏ (–∫–≤.–º. –∏ —à—Ç.)
  - –¶–µ–Ω–∞ –∑–∞ 1 –∫–≤.–º.

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø TELEGRAM (Markdown):
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π *—Ç–µ–∫—Å—Ç* –¥–ª—è –∫—É—Ä—Å–∏–≤–∞
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π **—Ç–µ–∫—Å—Ç** –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π [—Ç–µ–∫—Å—Ç](URL) –¥–ª—è —Å—Å—ã–ª–æ–∫
‚Ä¢ –î–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã: ‚Ä¢ –∏–ª–∏ -
‚Ä¢ –ü–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è: üìä üí∞ üè¢ üìç ‚úÖ ‚ùå üîç

–ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:

üí∞ **461 140 808,05 —Ä—É–±**

${context ? `\n–ö–û–ù–¢–ï–ö–°–¢ –î–ê–ù–ù–´–•:\n${context}` : ''}`
	}

	async generateResponse(
		prompt: string,
		context?: string,
		useWebSearch: boolean = true
	): Promise<string> {
		try {
			const systemPrompt = this.getSystemPrompt(context)

			const messages = [
				{
					role: 'system',
					content: systemPrompt,
				},
				{
					role: 'user',
					content: prompt,
				},
			]

			// –ï—Å–ª–∏ useWebSearch = false, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π gpt-4o (–¥–µ—à–µ–≤–ª–µ)
			// –ï—Å–ª–∏ useWebSearch = true, –∏—Å–ø–æ–ª—å–∑—É–µ–º gpt-4o-search-preview (—Å web search)
			const requestBody: any = {
				model: useWebSearch ? 'gpt-4o-search-preview' : 'gpt-4o',
				messages,
				max_tokens: 2000,
			}

			// –î–æ–±–∞–≤–ª—è–µ–º web_search_options —Ç–æ–ª—å–∫–æ –¥–ª—è search –º–æ–¥–µ–ª–∏
			if (useWebSearch) {
				requestBody.web_search_options = {}
			}

			this.logger.log(
				`Using model: ${requestBody.model} (web search: ${useWebSearch})`
			)

			const response = await firstValueFrom(
				this.httpService.post(`${this.baseUrl}/chat/completions`, requestBody, {
					headers: {
						Authorization: `Bearer ${this.apiKey}`,
						'Content-Type': 'application/json',
					},
				})
			)

			return (
				response.data.choices[0]?.message?.content ||
				'–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.'
			)
		} catch (error) {
			this.logger.error(`OpenAI API error: ${error.message}`)
			if (error.response?.data) {
				this.logger.error(
					`OpenAI API response: ${JSON.stringify(error.response.data)}`
				)
			}
			return '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.'
		}
	}

	async checkIfNeedsCsvData(query: string): Promise<boolean> {
		const queryLower = query.toLowerCase()

		const csvKeywords = [
			'–≤—ã—Ä—É—á–∫–∞',
			'–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏—è',
			'–æ–ø–ª–∞—Ç',
			'–ø–ª–∞—Ç–µ–∂',
			'–¥–¥—É',
			'–¥—É–ø—Ç',
			'–æ–±—ä–µ–º',
			'–ø–ª–æ—â–∞–¥—å',
			'–∫–≤.–º',
			'—Ü–µ–Ω–∞ –∑–∞',
			'–≥—Ä–∞—Ñ–∏–∫',
			'–æ—Å—Ç–∞—Ç–æ–∫',
			'well –æ–±–≤–æ–¥–Ω—ã–π',
			'well –º–æ—Å–∫–æ–≤—Å–∫–∏–π',
			'–µ–≤–≥–µ–Ω—å–µ–≤—Å–∫–∏–π',
			'–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç',
			'–∫–æ–º–º–µ—Ä—á–µ—Å–∫',
			'–∫–≤–∞—Ä—Ç–∏—Ä',
			'—Ñ–∞–∫—Ç–∏—á–µ—Å–∫',
			'–∑–∞–∫–æ–Ω—Ç—Ä–∞–∫—Ç',
			'–ø—Ä–æ–¥–∞–∂',
			'–ø–æ—Å—Ç—É–ø–ª–µ–Ω',
			'–¥–µ–Ω–µ–∂–Ω',
			'—Ñ–∏–Ω–∞–Ω—Å',
			'—Ä—É–±',
			'–º–ª–Ω',
			'—Ç—ã—Å',
		]

		const hasKeyword = csvKeywords.some(keyword => queryLower.includes(keyword))

		if (hasKeyword) {
			this.logger.log(`CSV data needed for query: "${query}" (keyword match)`)
			return true
		}

		try {
			const messages = [
				{
					role: 'system',
					content: `–¢—ã - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤. –û–ø—Ä–µ–¥–µ–ª–∏, –Ω—É–∂–Ω—ã –ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞.

–¢–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º:
- –ñ–ö "–ï–≤–≥–µ–Ω—å–µ–≤—Å–∫–∏–π" (–ö–≤–∞—Ä—Ç–∏—Ä—ã)
- Well –û–±–≤–æ–¥–Ω—ã–π (–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã, –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø–æ–º–µ—â–µ–Ω–∏—è)
- Well –ú–æ—Å–∫–æ–≤—Å–∫–∏–π (–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã, –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø–æ–º–µ—â–µ–Ω–∏—è)

–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ:
- –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏ (–î–î–£, –î–£–ü–¢)
- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–ª–∞—Ç—ã (–î–î–£, –î–£–ü–¢)
- –ì—Ä–∞—Ñ–∏–∫ –æ–ø–ª–∞—Ç—ã –æ—Å—Ç–∞—Ç–∫–∞
- –û–±—ä–µ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ü–∏–∏ (–∫–≤.–º., —à—Ç.)
- –¶–µ–Ω–∞ –∑–∞ 1 –∫–≤.–º.

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ —ç—Ç–∏ –ø—Ä–æ–µ–∫—Ç—ã –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ - –æ—Ç–≤–µ—Ç—å true.
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –æ–ø–∏—Å–∞–Ω–∏–µ - –æ—Ç–≤–µ—Ç—å false.

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û: true –∏–ª–∏ false`,
				},
				{
					role: 'user',
					content: query,
				},
			]

			const response = await firstValueFrom(
				this.httpService.post(
					`${this.baseUrl}/chat/completions`,
					{
						model: 'gpt-4o',
						messages,
						max_tokens: 10,
					},
					{
						headers: {
							Authorization: `Bearer ${this.apiKey}`,
							'Content-Type': 'application/json',
						},
					}
				)
			)

			const answer = response.data.choices[0]?.message?.content || 'false'
			const cleaned = answer.toLowerCase().trim()

			this.logger.log(`CSV check for "${query}": ${cleaned}`)

			return cleaned.includes('true')
		} catch (error) {
			this.logger.error(`CSV check error: ${error.message}`)
			return hasKeyword
		}
	}

	async analyzePropertyQuery(query: string): Promise<{
		intent: string
		parameters: Record<string, any>
	}> {
		try {
			const prompt = `
      –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:
      1. –ù–∞–º–µ—Ä–µ–Ω–∏–µ (intent): search, info, price, availability, comparison
      2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å): —Ç–∏–ø, –ø–ª–æ—â–∞–¥—å, —Ü–µ–Ω–∞, —ç—Ç–∞–∂, –∫–æ–º–Ω–∞—Ç—ã, –æ—á–µ—Ä–µ–¥—å
      
      –ó–∞–ø—Ä–æ—Å: "${query}"
      
      –û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
      {
        "intent": "search|info|price|availability|comparison",
        "parameters": {
          "type": "—Ç–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
          "area": "–ø–ª–æ—â–∞–¥—å",
          "price": "—Ü–µ–Ω–∞",
          "floor": "—ç—Ç–∞–∂",
          "rooms": "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç",
          "phase": "–æ—á–µ—Ä–µ–¥—å"
        }
      }
      `

			const response = await this.generateResponse(prompt)

			try {
				return JSON.parse(response)
			} catch {
				return {
					intent: 'search',
					parameters: {},
				}
			}
		} catch (error) {
			this.logger.error(`Query analysis error: ${error.message}`)
			return {
				intent: 'search',
				parameters: {},
			}
		}
	}

	async *generateResponseStream(
		prompt: string,
		context?: string,
		useWebSearch: boolean = true
	): AsyncGenerator<string> {
		try {
			const systemPrompt = this.getSystemPrompt(context)

			const messages = [
				{
					role: 'system',
					content: systemPrompt,
				},
				{
					role: 'user',
					content: prompt,
				},
			]

			const requestBody: any = {
				model: useWebSearch ? 'gpt-4o-search-preview' : 'gpt-4o',
				messages,
				stream: true,
			}

			// –î–æ–±–∞–≤–ª—è–µ–º web_search_options —Ç–æ–ª—å–∫–æ –¥–ª—è search –º–æ–¥–µ–ª–∏
			if (useWebSearch) {
				requestBody.web_search_options = {}
			}

			this.logger.log(
				`Sending request to OpenAI: ${JSON.stringify(requestBody, null, 2)}`
			)

			const response = await fetch(`${this.baseUrl}/chat/completions`, {
				method: 'POST',
				headers: {
					Authorization: `Bearer ${this.apiKey}`,
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(requestBody),
			})

			if (!response.ok) {
				const errorText = await response.text()
				this.logger.error(
					`OpenAI API HTTP error: ${response.status} ${response.statusText}`
				)
				this.logger.error(`OpenAI API error body: ${errorText}`)
				throw new Error(`HTTP ${response.status}: ${errorText}`)
			}

			const reader = response.body.getReader()
			const decoder = new TextDecoder()

			while (true) {
				const { done, value } = await reader.read()
				if (done) break

				const chunk = decoder.decode(value)
				const lines = chunk.split('\n').filter(line => line.trim() !== '')

				for (const line of lines) {
					if (line.startsWith('data: ')) {
						const data = line.slice(6)
						if (data === '[DONE]') continue

						try {
							const parsed = JSON.parse(data)
							const content = parsed.choices[0]?.delta?.content
							if (content) {
								yield content
							}
						} catch (e) {
							// –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
						}
					}
				}
			}
		} catch (error) {
			this.logger.error(`OpenAI Stream API error: ${error.message}`)
			this.logger.error(`Error stack: ${error.stack}`)
			yield '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.'
		}
	}
}
